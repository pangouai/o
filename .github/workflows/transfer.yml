name: OneDrive to OneDrive (TG Hourly Progress)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  transfer:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - uses: actions/checkout@v4

      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: Setup rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONF }}" > ~/.config/rclone/rclone.conf

      - name: Start copy (background)
        run: |
          rclone copy ndja:/ n2:/ \
            --transfers=2 \
            --checkers=4 \
            --tpslimit=4 \
            --retries 20 \
            --low-level-retries 50 \
            --stats=0 \
            --log-level INFO \
            --log-file rclone.log &
          echo $! > rclone.pid

      - name: TG hourly progress notify
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          while kill -0 "$(cat rclone.pid)" 2>/dev/null; do
            SRC=$(rclone size ndja:/ | grep "Total size" | awk '{print $3" "$4}')
            DST=$(rclone size n2:/ | grep "Total size" | awk '{print $3" "$4}')

            MSG="OneDrive转存进度 | 源盘:${SRC} | 已完成:${DST} | 状态:运行中"

            curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TG_CHAT_ID}" \
              --data-urlencode text="${MSG}"

            sleep 3600
          done
